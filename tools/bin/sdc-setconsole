#!/usr/bin/bash
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
#

#
# Copyright (c) 2018, Joyent, Inc.
#

#
# Usage:
#
#  sdc-setconsole <console>
#

function usage
{
    cat <<USAGE
Usage: $0 [ttya|ttyb|ttyc|ttyd|text]

Example:

    $0 ttyb

USAGE

    exit 1
}

function fatal
{
    echo "`basename $0`: $*" >&2 
    exit 1
}

function config_loader
{
    local readonly tmpconf=$(mktemp /tmp/loader.conf.XXXX)

    cat $loader_conf | grep -v os_console > $tmpconf
    echo "os_console=\"${console}\"" >> $tmpconf
    mv -f $tmpconf $loader_conf
}

function config_grub
{
    sed -e "s/^variable os_console.*/variable os_console ${console}/" \
        < ${grub_menu} > /tmp/menu.lst.$$
    mv -f /tmp/menu.lst.$$ ${grub_menu}
    sed -e "s/^variable os_console.*/variable os_console ${console}/" \
        < ${grub_menutmpl} > /tmp/menu.lst.tmpl.$$
    mv -f /tmp/menu.lst.tmpl.$$ $grub_{menutmpl}
}

if [[ -z "$1" ]]; then
    usage
fi

console=$1

case "${console}" in
ttya|ttyb|ttyc|ttyd|text)
    ;;
graphics|vga)
    console=text
    ;;
*)
    usage
    ;;
esac

usbmnt=$(/opt/smartdc/bin/sdc-usbkey mount)
[ $? != 0 ] && fatal "failed to mount USB key"

readonly grub_menu="${usbmnt}/boot/grub/menu.lst"
readonly grub_menutmpl="${grub_menu}.tmpl"
readonly loader_conf="${usbmnt}/boot/loader.conf"

# XXX - change to look at MBR version
echo -n "Setting default OS console to ${console} ... "
if [[ -f ${loader_conf} ]]; then
	config_loader
elif [[ -f ${grub_menu} ]]; then
	config_grub
else
	fatal "No boot loader configuration found!"
fi
echo "done."

echo -n "Unmounting USB key ... "
/opt/smartdc/bin/sdc-usbkey unmount
[ $? != 0 ] && fatal "failed to unmount USB key"

echo "done."

exit 0
